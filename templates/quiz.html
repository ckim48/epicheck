{% extends "nav.html" %}
{% block title %}Quiz • EPICHECK{% endblock %}
{% block extra_head %}
<style>
  /* ==== Self-contained styles (no CSS variables required) ==== */
    body{
      color:black;
    }
            h3{
              color:black;
            }
  /* HERO */
  .quiz-hero{
    border-radius: 20px;
    padding: 28px;
    color:#fff;
    position:relative; overflow:hidden;
    background: linear-gradient(135deg,#111827 0%, #1f2937 60%);
    box-shadow: 0 10px 28px rgba(0,0,0,.10);
  }
  #pointCounter{
    color:black;
  }
  .quiz-hero::after{
    content:""; position:absolute; inset:-20%;
    background:
      radial-gradient(700px 180px at 6% -10%, rgba(99,102,241,.35), transparent 55%),
      radial-gradient(700px 180px at 96% 120%, rgba(16,185,129,.35), transparent 55%);
    pointer-events:none;
  }

  /* GLASS CARD (explicit colors; no vars) */
  .glass {
    background: rgba(255,255,255,.70);
    -webkit-backdrop-filter: blur(12px);
    backdrop-filter: blur(12px);
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.35);
    box-shadow: 0 10px 28px rgba(0,0,0,.08);
  }
  @media (prefers-color-scheme: dark){
    .glass {
      background: rgba(23,25,35,.65);
      border-color: rgba(255,255,255,.08);
    }
  }

  /* TEXT UTILS */
  .muted{ color: #6b7280; font-size:.92rem; }
  @media (prefers-color-scheme: dark){ .muted{ color:#98a2b3; } }

  /* TOOLBAR / BADGES */
  .toolbar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .pill {
    color:black;
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 12px; border-radius:999px; font-weight:600;
    background: rgba(255,255,255,.14); color:#fff;
  }
  .pill .dot{ width:8px; height:8px;color:black; border-radius:999px; background:#10b981; }

  /* INPUTS & BUTTONS */
  .search-xl { height: 54px; font-size: 1.05rem; border-radius: 14px; }
  .btn-clean {
    border: 1px solid rgba(0,0,0,.12);
    background: #ffffff; color:#111827; font-weight:600; border-radius:12px;
    padding:.6rem 1.2rem; transition: all .18s ease; box-shadow: 0 4px 10px rgba(0,0,0,.05);
  }
  .btn-clean:hover{ background:#f9fafb; border-color:rgba(0,0,0,.18); box-shadow: 0 6px 14px rgba(0,0,0,.08); }
  @media (prefers-color-scheme: dark){
    .btn-clean{
      background: rgba(255,255,255,.08); color:#e8eaed; border:1px solid rgba(255,255,255,.12);
    }
    .btn-clean:hover{ background: rgba(255,255,255,.12); }
  }

  /* QUESTION CARD */
  .q-card{
    border:1px solid rgba(0,0,0,.06);
    border-radius:16px;
    background: rgba(255,255,255,.65);
    padding:16px 16px 12px;
    transition: box-shadow .18s ease, transform .12s ease;
  }
  .q-card:hover{ transform: translateY(-1px); box-shadow: 0 16px 28px rgba(0,0,0,.08); }
  @media (prefers-color-scheme: dark){
    .q-card{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12); }
  }

  .q-head { display:flex; gap:12px; align-items:flex-start; justify-content:space-between; }
  .q-badge{
    min-width:32px; height:32px; border-radius:10px;
    display:inline-flex; align-items:center; justify-content:center;
    font-weight:800; background: rgba(0,0,0,.06); color:#111827;
  }
  @media (prefers-color-scheme: dark){
    .q-badge{ background: rgba(255,255,255,.10); color:#e8eaed; }
  }
  .q-title{ margin:0; font-weight:700; font-size:1rem; line-height:1.35; }

  /* CHOICES */
  .choice{
    display:flex; gap:10px; align-items:center;
    border:1px solid rgba(0,0,0,.10);
    border-radius:12px; padding:10px 12px; cursor:pointer; user-select:none;
    background: rgba(255,255,255,.85);
    transition: background .12s ease, border-color .12s ease, box-shadow .12s ease, transform .06s ease;
  }
  .choice:hover{ background:#ffffff; transform: translateY(-1px); }
  @media (prefers-color-scheme: dark){
    .choice{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.12); }
    .choice:hover{ background: rgba(255,255,255,.12); }
  }
  .choice .bullet{
    width:18px; height:18px; border-radius:50%;
    border:2px solid rgba(0,0,0,.25);
    display:inline-block; flex:0 0 18px;
  }
  @media (prefers-color-scheme: dark){ .choice .bullet{ border-color: rgba(255,255,255,.35); } }

  .choice.correct{
    border-color:#10b981; box-shadow: 0 0 0 3px rgba(16,185,129,.22) inset;
  }
  .choice.correct .bullet{ border-color:#10b981; background:#10b981; }
  .choice.wrong{
    border-color:#ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,.16) inset;
  }
  .choice.disabled{ opacity:.75; cursor:default; }

  /* EXPLANATION */
  .explain{
    display:none; border-radius:12px; padding:10px 12px; margin-top:10px;
    background: rgba(16,185,129,.10); border: 1px solid rgba(16,185,129,.25);
  }
  .explain.bad{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25); }

  /* EMPTY STATE */
  .empty{
    padding:28px; border-radius:16px;
    background: rgba(0,0,0,.03); border:1px dashed rgba(0,0,0,.10);
  }
  @media (prefers-color-scheme: dark){
    .empty{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.14); }
  }
</style>
{% endblock %}


{% block content %}
<section class="container my-3">
  <div class="quiz-hero glass">
    <div class="d-flex flex-wrap align-items-center justify-content-between">
      <div>
        <h3 class="mb-1">Quiz • EPICHECK</h3>
<!--        <div class="muted">Evidence-based MCQs grounded in WHO/CDC/NIH/MedlinePlus sources.</div>-->
      </div>
      <div class="toolbar">
        <span class="pill"><span class="dot"></span> <span style="color:black;">Points: </span><strong id="pointCounter">{{ points or 0 }}</strong></span>
      </div>
    </div>

  </div>
</section>

<section class="container my-3">
  {% if items and items|length > 0 %}
    <div class="row g-3">
      {% for it in items %}
      <div class="col-12">
        <div class="q-card glass" data-idx="{{ loop.index0 }}">
          <div class="q-head">
            <div class="d-flex align-items-start gap-2">
              <span class="q-badge">{{ loop.index }}</span>
              <h6 class="q-title"> {{ it.q }} </h6>
            </div>
            <div class="muted text-end small">
              Source: <a href="{{ it.source }}" target="_blank" rel="noopener">{{ it.source }}</a>
            </div>
          </div>

          <div class="row g-2 mt-2">
            {% for ch in it.choices %}
            <div class="col-12 col-md-6">
              <div class="choice" data-choice="{{ loop.index0 }}">
                <span class="bullet"></span>
                <span>{{ ch }}</span>
              </div>
            </div>
            {% endfor %}
          </div>

          <div class="explain mt-2 small" id="explain-{{ loop.index0 }}"></div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% elif topic %}
    <div class="glass empty">
      <div class="mb-2"><strong>No quiz items generated.</strong></div>
      <div class="muted">Try a more specific topic or run Monitor first to collect better citations.</div>
    </div>
  {% else %}
    <div class="glass empty">
      <div class="muted">Enter a topic above to generate evidence-based questions.</div>
    </div>
  {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  // Answer handler with correct-index reveal
  document.querySelectorAll('.q-card .choice').forEach(el => {
    el.addEventListener('click', async () => {
      const card = el.closest('.q-card');
      const idx = Number(card.dataset.idx);
      const choice = Number(el.dataset.choice);

      if (card.dataset.done === "1") return;

      try {
        const resp = await fetch("{{ url_for('quiz_answer') }}", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ idx, choice })
        });
        const data = await resp.json();
        if (!data.ok) return;

        // disable further clicks
        card.dataset.done = "1";
        card.querySelectorAll('.choice').forEach(c => c.classList.add('disabled'));

        // mark chosen
        if (data.correct) {
          el.classList.add('correct');
        } else {
          el.classList.add('wrong');
          // highlight correct one
          const all = [...card.querySelectorAll('.choice')];
          const correctEl = all[data.answer_idx];
          if (correctEl) correctEl.classList.add('correct');
        }

        // explanation
        const ex = card.querySelector('#explain-'+idx);
        if (ex) {
          ex.style.display = 'block';
          ex.classList.toggle('bad', !data.correct);
          ex.innerHTML = `${data.correct ? "Correct." : "Not quite."} ${data.explain}
            <br><a class="small" href="${data.source}" target="_blank" rel="noopener">Read source</a>`;
        }

        // points
        const pc = document.getElementById('pointCounter');
        if (pc) pc.textContent = data.points;

      } catch(e){ /* no-op */ }
    });
  });
</script>
{% endblock %}
