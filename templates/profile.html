{% extends "nav.html" %}
{% block title %}Profile • EPICHECK{% endblock %}
{% block extra_head %}
<style>
  .dash-hero{
    border-radius: 20px; padding: 26px; color:#fff; position:relative; overflow:hidden;
    background: linear-gradient(135deg,#0f172a 0%, #1e293b 65%);
    box-shadow: 0 10px 28px rgba(0,0,0,.12);
  }
  .dash-hero::after{
    content:""; position:absolute; inset:-15%;
    background:
      radial-gradient(600px 180px at 0% 0%, rgba(99,102,241,.35), transparent 55%),
      radial-gradient(600px 180px at 100% 120%, rgba(16,185,129,.35), transparent 55%);
    pointer-events:none;
  }
  .glass{ background: rgba(255,255,255,.70); backdrop-filter: blur(12px);
          border-radius: 16px; border:1px solid rgba(255,255,255,.35);
          box-shadow: 0 10px 24px rgba(0,0,0,.08); }
  @media (prefers-color-scheme: dark){
    .glass{ background: rgba(23,25,35,.65); border-color: rgba(255,255,255,.08); }
  }
  .stat-card{ padding:18px; }
  .stat-k{ font-weight:800; font-size:1.6rem; line-height:1; }
  .muted{ color:#6b7280; } @media (prefers-color-scheme: dark){ .muted{ color:#98a2b3; } }
  .badge-pill{ border-radius:999px; padding:.35rem .6rem; font-weight:700; }
  .badge-daily{ background:rgba(99,102,241,.15); color:#6366f1; }
  .badge-custom{ background:rgba(16,185,129,.15); color:#10b981; }
  .table thead th{ font-size:.82rem; letter-spacing:.02em; text-transform:uppercase; }
  .kw-chip{
    display:inline-flex; align-items:center; gap:.4rem;
    padding:.4rem .6rem; border-radius:999px; font-weight:600;
    background: rgba(0,0,0,.06);
  }
  @media (prefers-color-scheme: dark){
    .kw-chip{ background: rgba(255,255,255,.10); }
  }
  .mini-pill{ border-radius:999px; padding:.2rem .45rem; font-size:.75rem; }
  .p-valid{ background:rgba(34,197,94,.18); color:#16a34a; }
  .p-invalid{ background:rgba(239,68,68,.18); color:#dc2626; }
  .p-uncertain{ background:rgba(234,179,8,.20); color:#b45309; }
  .progress{ height:8px; background: rgba(0,0,0,.08); }
  @media (prefers-color-scheme: dark){ .progress{ background: rgba(255,255,255,.12); } }
</style>
{% endblock %}

{% block content %}
<section class="container my-3">
  <div class="dash-hero">
    <div class="d-flex flex-wrap align-items-center justify-content-between">
      <div>
        <h4 class="mb-1">{{ 'Guest Dashboard' if is_guest else (user.name or 'Your Dashboard') }}</h4>
        <div class="muted small">
          {{ 'You are viewing a guest session (scores saved to this browser).' if is_guest else (user.email or '') }}
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-light btn-sm" href="{{ url_for('quiz_daily') }}"><i class="bi bi-stars me-1"></i> Daily Quiz</a>
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('monitor') }}"><i class="bi bi-activity me-1"></i> Monitor</a>
      </div>
    </div>
  </div>
</section>

<section class="container my-3">
  <!-- Stats row -->
  <div class="row g-3">
    <div class="col-12 col-md-3">
      <div class="glass stat-card">
        <div class="muted small">Quizzes Taken</div>
        <div class="stat-k">{{ stats.total_quizzes or 0 }}</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="glass stat-card">
        <div class="muted small">Best Score</div>
        <div class="stat-k">{{ (stats.best_score or 0) }}</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="glass stat-card">
        <div class="muted small">Average Score</div>
        <div class="stat-k">{{ (stats.avg_score or 0)|round(2) }}</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="glass stat-card">
        <div class="muted small">Last Active</div>
        <div class="stat-k" style="font-size:1.05rem;">
          {{ (stats.last_active|dt) if stats.last_active else '—' }}
        </div>
      </div>
    </div>
  </div>
</section>

<section class="container my-3">
  <div class="glass p-3">
    <div class="d-flex align-items-center justify-content-between">
      <h6 class="mb-0">Recent Quiz Attempts</h6>
      <a class="btn btn-sm btn-clean" href="{{ url_for('quiz_daily') }}"><i class="bi bi-play-circle me-1"></i>Take another</a>
    </div>
    <div class="table-responsive mt-2">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>Topic</th>
            <th>Type</th>
            <th class="text-center">Progress</th>
            <th class="text-end">Score</th>
          </tr>
        </thead>
        <tbody>
          {% if attempts %}
            {% for a in attempts %}
            <tr>
              <td class="small">{{ a.started_at|dt }}</td>
              <td class="fw-semibold">{{ a.topic }}</td>
              <td>
                {% if a.is_daily %}
                  <span class="badge-pill badge-daily">Daily</span>
                {% else %}
                  <span class="badge-pill badge-custom">Custom</span>
                {% endif %}
              </td>
              <td class="text-center" style="min-width:160px;">
                {% set total = a.total_items or 0 %}
                {% set ans = a.answered or 0 %}
                {% set pct = (ans / total * 100) if total>0 else 0 %}
                <div class="progress"><div class="progress-bar" role="progressbar" style="width: {{ pct|round(0) }}%"></div></div>
                <div class="small muted mt-1">{{ ans }}/{{ total }} answered</div>
              </td>
              <td class="text-end fw-bold">{{ a.score }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="text-center text-muted py-4">No attempts yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="container my-3">
  <div class="glass p-3">
    <div class="d-flex align-items-center justify-content-between">
      <h6 class="mb-0">Recent Searches</h6>
      <a class="btn btn-sm btn-clean" href="{{ url_for('monitor') }}"><i class="bi bi-activity me-1"></i>Open Monitor</a>
    </div>
    <div class="mt-2">
      {% if searches %}
        {% for s in searches %}
          <div class="d-flex flex-wrap align-items-center justify-content-between py-2 border-bottom border-opacity-25">
            <div class="d-flex align-items-center gap-2">
              <span class="kw-chip"><i class="bi bi-search"></i> {{ s.keywords }}</span>
              <span class="small muted">on {{ s.created_at|dt }}</span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <span class="mini-pill p-valid">Valid {{ s.valid_count or 0 }}</span>
              <span class="mini-pill p-invalid">Invalid {{ s.invalid_count or 0 }}</span>
              <span class="mini-pill p-uncertain">Uncertain {{ s.uncertain_count or 0 }}</span>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center text-muted py-4">No searches yet.</div>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
